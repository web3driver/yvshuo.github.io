<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
    
  
  <title>
    Sequelize使用报告|香辣猪蹄儿
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近在试水阿里的 node 服务端框架 egg，所以摸了一下 node 服务端相关的技术。等项目做完后会好好总结一下 egg 相关的使用经验。这篇文章是为了记录 node 端的 ORM 库：Sequelize。如果是速查的话，请直接翻到文章最后，从官方文档中整理了常用功能速查表。 1. Sequelize 的用途之所以要使用Sequelize的用途,是因为我用的是 mysql。而在 node 端要">
<meta name="keywords" content="数据库,ORM">
<meta property="og:type" content="article">
<meta property="og:title" content="Sequelize使用报告">
<meta property="og:url" content="http://yvshuo.github.io/2018/03/15/2018-03-15-Sequelize/index.html">
<meta property="og:site_name" content="香辣猪蹄儿">
<meta property="og:description" content="最近在试水阿里的 node 服务端框架 egg，所以摸了一下 node 服务端相关的技术。等项目做完后会好好总结一下 egg 相关的使用经验。这篇文章是为了记录 node 端的 ORM 库：Sequelize。如果是速查的话，请直接翻到文章最后，从官方文档中整理了常用功能速查表。 1. Sequelize 的用途之所以要使用Sequelize的用途,是因为我用的是 mysql。而在 node 端要">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-11T01:52:30.333Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sequelize使用报告">
<meta name="twitter:description" content="最近在试水阿里的 node 服务端框架 egg，所以摸了一下 node 服务端相关的技术。等项目做完后会好好总结一下 egg 相关的使用经验。这篇文章是为了记录 node 端的 ORM 库：Sequelize。如果是速查的话，请直接翻到文章最后，从官方文档中整理了常用功能速查表。 1. Sequelize 的用途之所以要使用Sequelize的用途,是因为我用的是 mysql。而在 node 端要">
  
    <link rel="alternate" href="/atom.xml" title="config.title" type="application/atom+xml">
  
  
    <link rel="icon" href="/blog/assets/images/global/favicon.ico" >
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/page.css">
  <script src="/blog/js/vue.min.js"></script>
  <script>window.PAGE_TYPE = ""</script>
</head>
<body class="docs">
  
  <div id="mobile-bar" >
  <a class="menu-button"></a>
  <a class="logo" href="/"></a>
  
    <a class="back" href="javascript:history.go(-1)"></a>
  
</div>
  <div id="header">
  <a id="logo" href="/">
    <img src="/blog/img/avatar.jpg">
    <span>香辣猪蹄儿</span>
  </a>
  <ul id="nav">
    <li><a href="/blog" class="nav-link">首页</a></li>
<li><a href="/blog/archives" class="nav-link">文章列表</a></li>
<li><a href="/blog/tags" class="nav-link">标签列表</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">文档</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/blog/docs/alibaba" class="nav-link">阿里巴巴java开发手册解读</a></li>
    <li><a href="/blog/docs/es6" class="nav-link">ES6温故而知新</a></li>
  </ul>
</li>
  </ul>
</div>

  <div id="main" class="fix-sidebar">
      
    <div class="sidebar blog">
        <ul class="main-menu">
            <li><a href="/blog" class="nav-link">首页</a></li>
<li><a href="/blog/archives" class="nav-link">文章列表</a></li>
<li><a href="/blog/tags" class="nav-link">标签列表</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">文档</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/blog/docs/alibaba" class="nav-link">阿里巴巴java开发手册解读</a></li>
    <li><a href="/blog/docs/es6" class="nav-link">ES6温故而知新</a></li>
  </ul>
</li>
        </ul>
        <div class="list">
            <h2>
                文章列表
                <span style="font-weight:normal;font-size:16px">（共33篇）</span>
            </h2>
            <ul style="padding:0">
            
            
                
                    <li>
                        <a href="/blog/2018/03/15/2018-03-15-Sequelize/" class="sidebar-link current">1、Sequelize使用报告</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2018/03/13/2018-03-13-banip/" class="sidebar-link">2、linux服务器初级防护</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2018/01/26/2018-01-26-vba/" class="sidebar-link">3、给前端er的EXCEL VBA编程快速入门手册</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/10/27/2017-10-27-refactor-review/" class="sidebar-link">4、重构项目总结</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/06/10/2017-06-10-vod/" class="sidebar-link">5、腾讯云视频点播接口开发记录</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/05/31/2017-05-31-sixone-md/" class="sidebar-link">6、六一</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/05/19/2017-05-19-kotlin/" class="sidebar-link">7、kotlin学习资源</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/05/10/2017-05-10-is/" class="sidebar-link">8、javascript常见判断研究</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/05/10/2017-05-10-NaN/" class="sidebar-link">9、说一说数组去重</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/04/27/2017-04-27-scopechain/" class="sidebar-link">10、js作用域链</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/04/01/2017-04-01-easytiny-1/" class="sidebar-link">11、easytiny 简易说明</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/03/26/2017-03-26-hexo-theme-yvue-1/" class="sidebar-link">12、(多图慎入!)类vue官网的hexo主题yvue发布Beta0.1版本</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/03/25/2017-03-25-es6-4/" class="sidebar-link">13、Promises</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/03/25/2017-03-25-es6-3/" class="sidebar-link">14、Modules</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/03/19/2017-03-19-es6-2/" class="sidebar-link">15、Default + Rest + Spread</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/03/19/2017-03-19-es6-1/" class="sidebar-link">16、Arrows and Lexical This</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/23/2017-02-23-javarule-9/" class="sidebar-link">17、阿里巴巴java开发手册解读9-其他编程规约</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/23/2017-02-23-javarule-8/" class="sidebar-link">18、阿里巴巴java开发手册解读8-注释规约</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/22/2017-02-22-javarule-7/" class="sidebar-link">19、阿里巴巴java开发手册解读7-控制语句</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/18/2017-02-18-javarule-6/" class="sidebar-link">20、阿里巴巴java开发手册解读6-并发处理</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/17/2017-02-17-javarule-5/" class="sidebar-link">21、阿里巴巴java开发手册解读5-集合处理</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/13/2017-02-10-javarule-4/" class="sidebar-link">22、阿里巴巴java开发手册解读4-OOP 规约</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/10/2017-02-10-javarule-3/" class="sidebar-link">23、阿里巴巴java开发手册解读3-格式规约</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/10/2017-02-10-javarule-2/" class="sidebar-link">24、阿里巴巴java开发手册解读2-常量定义</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/02/09/2017-02-09-javarule-1/" class="sidebar-link">25、阿里巴巴java开发手册解读1-命名规约</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/01/16/2017-01-16-refactor/" class="sidebar-link">26、重构—重新组织函数</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2017/01/11/2017-01-11-review-git/" class="sidebar-link">27、git知识备忘</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/11/27/2016-11-27-wxapp/" class="sidebar-link">28、微信小程序初体验</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/11/15/2016-11-15-eslint/" class="sidebar-link">29、使用ESLint检查语法和代码风格</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/10/26/2016-10-26-webpacknote/" class="sidebar-link">30、webpack简介</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/10/11/2016-10-11-closure/" class="sidebar-link">31、一篇关于javascript闭包的笔记</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/10/07/2016-10-07-githubssh/" class="sidebar-link">32、配置hexo的一键打包部署</a>
                    </li>
                
            
                
                    <li>
                        <a href="/blog/2016/10/06/2016-10-06-create/" class="sidebar-link">33、使用hexo在github上搭建博客的记录</a>
                    </li>
                
            
            </ul>
        </div>
    </div>
    <div class="content with-sidebar blog post">
        <h1>Sequelize使用报告</h1>
        <h4>Mar 15, 2018
            
            
                <span id="/blog/2018/03/15/2018-03-15-Sequelize/" class="leancloud_visitors" data-flag-title="Sequelize使用报告">
                    <span class="leancloud-visitors-count"></span>
                </span>
            
        </h4>
        
        
        <p>最近在试水阿里的 node 服务端框架 <code>egg</code>，所以摸了一下 node 服务端相关的技术。等项目做完后会好好总结一下 egg 相关的使用经验。这篇文章是为了记录 node 端的 ORM 库：<a href="http://docs.sequelizejs.com/" target="_blank" rel="noopener"><code>Sequelize</code></a>。如果是速查的话，请直接翻到文章最后，从官方文档中整理了<a href="#4-sequelizejs常用基本用法速查表">常用功能速查表</a>。</p>
<h2 id="1-Sequelize-的用途"><a href="#1-Sequelize-的用途" class="headerlink" title="1. Sequelize 的用途"></a>1. Sequelize 的用途</h2><p>之所以要使用<code>Sequelize</code>的用途,是因为我用的是 mysql。而在 node 端要使用 mysql 的话，最常用的库就是<a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener">mysql</a>。这个库提供了基本的操作 mysql 的数据库的能力，类似于 java 的 JDBC。这时候聪明的你就会想到，在 java 里，大多数情况下，我们并不会手撸 mysql，而是使用一些进一步封装过得如 Hibernate、mybatis 这样的专门来撸数据持久层代码的库。这种封装我们称之为 ORM（Object Relational Mapping）。简单的说就是把关系数据库的表映射到对象上~有了这种 ORM 的库，我们就不需要手撸 sql 了，用操作对象的方式就可以撸数据库了。<code>Sequelize</code>就是 node 服务端最著名的 ORM 库。</p>
<a id="more"></a>
<h2 id="2-Sequelize-的常用功能"><a href="#2-Sequelize-的常用功能" class="headerlink" title="2. Sequelize 的常用功能"></a>2. Sequelize 的常用功能</h2><h3 id="2-1-新建-Sequelize-的全部配置"><a href="#2-1-新建-Sequelize-的全部配置" class="headerlink" title="2.1 新建 Sequelize 的全部配置"></a>2.1 新建 Sequelize 的全部配置</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(<span class="string">'database'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>, &#123;</div><div class="line">  <span class="comment">// the sql dialect of the database</span></div><div class="line">  <span class="comment">// currently supported: 'mysql', 'sqlite', 'postgres', 'mssql'</span></div><div class="line">  dialect: <span class="string">'mysql'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// custom host; default: localhost</span></div><div class="line">  host: <span class="string">'my.server.tld'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// custom port; default: dialect default</span></div><div class="line">  port: <span class="number">12345</span>,</div><div class="line"></div><div class="line">  <span class="comment">// custom protocol; default: 'tcp'</span></div><div class="line">  <span class="comment">// postgres only, useful for Heroku</span></div><div class="line">  protocol: <span class="literal">null</span>,</div><div class="line"></div><div class="line">  <span class="comment">// disable logging; default: console.log</span></div><div class="line">  logging: <span class="literal">false</span>,</div><div class="line"></div><div class="line">  <span class="comment">// you can also pass any dialect options to the underlying dialect library</span></div><div class="line">  <span class="comment">// - default is empty</span></div><div class="line">  <span class="comment">// - currently supported: 'mysql', 'postgres', 'mssql'</span></div><div class="line">  dialectOptions: &#123;</div><div class="line">    socketPath: <span class="string">'/Applications/MAMP/tmp/mysql/mysql.sock'</span>,</div><div class="line">    supportBigNumbers: <span class="literal">true</span>,</div><div class="line">    bigNumberStrings: <span class="literal">true</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// the storage engine for sqlite</span></div><div class="line">  <span class="comment">// - default ':memory:'</span></div><div class="line">  storage: <span class="string">'path/to/database.sqlite'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// disable inserting undefined values as NULL</span></div><div class="line">  <span class="comment">// - default: false</span></div><div class="line">  omitNull: <span class="literal">true</span>,</div><div class="line"></div><div class="line">  <span class="comment">// a flag for using a native library or not.</span></div><div class="line">  <span class="comment">// in the case of 'pg' -- set this to true will allow SSL support</span></div><div class="line">  <span class="comment">// - default: false</span></div><div class="line">  native: <span class="literal">true</span>,</div><div class="line"></div><div class="line">  <span class="comment">// Specify options, which are used when sequelize.define is called.</span></div><div class="line">  <span class="comment">// The following example:</span></div><div class="line">  <span class="comment">//   define: &#123; timestamps: false &#125;</span></div><div class="line">  <span class="comment">// is basically the same as:</span></div><div class="line">  <span class="comment">//   sequelize.define(name, attributes, &#123; timestamps: false &#125;)</span></div><div class="line">  <span class="comment">// so defining the timestamps for each model will be not necessary</span></div><div class="line">  define: &#123;</div><div class="line">    underscored: <span class="literal">false</span></div><div class="line">    freezeTableName: <span class="literal">false</span>,</div><div class="line">    charset: <span class="string">'utf8'</span>,</div><div class="line">    dialectOptions: &#123;</div><div class="line">      collate: <span class="string">'utf8_general_ci'</span></div><div class="line">    &#125;,</div><div class="line">    timestamps: <span class="literal">true</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// similar for sync: you can define this to always force sync for models</span></div><div class="line">  sync: &#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// pool configuration used to pool database connections</span></div><div class="line">  pool: &#123;</div><div class="line">    max: <span class="number">5</span>,</div><div class="line">    idle: <span class="number">30000</span>,</div><div class="line">    acquire: <span class="number">60000</span>,</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// isolation level of each transaction</span></div><div class="line">  <span class="comment">// defaults to dialect default</span></div><div class="line">  isolationLevel: Transaction.ISOLATION_LEVELS.REPEATABLE_READ</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>配置完后，可以使用内置 <code>authenticate</code> 方法测试连接是否成功。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">sequelize</div><div class="line">  .authenticate()</div><div class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Connection has been established successfully.'</span>);</div><div class="line">  &#125;)</div><div class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">'Unable to connect to the database:'</span>, err);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<h3 id="2-2-Sequelize-的基本用法"><a href="#2-2-Sequelize-的基本用法" class="headerlink" title="2.2 Sequelize 的基本用法"></a>2.2 Sequelize 的基本用法</h3><p>定义 model：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> User = sequelize.define(<span class="string">'user'</span>, &#123;</div><div class="line">  firstName: &#123;</div><div class="line">    type: Sequelize.STRING</div><div class="line">  &#125;,</div><div class="line">  lastName: &#123;</div><div class="line">    type: Sequelize.STRING</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// force: true will drop the table if it already exists</span></div><div class="line">User.sync(&#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// Table created</span></div><div class="line">  <span class="keyword">return</span> User.create(&#123;</div><div class="line">    firstName: <span class="string">'John'</span>,</div><div class="line">    lastName: <span class="string">'Hancock'</span></div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>基本的查询:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">User.findAll().then(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(users);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>常用的还有 create（增）、destroy（删）、update（改）、findOne（查单条）、findAll（查多条）等等。更多信息可以参看<a href="http://docs.sequelizejs.com/manual/tutorial/querying.html" target="_blank" rel="noopener">sequelizejs Querying</a>。</p>
<p>联合查询：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// model中定义外键</span></div><div class="line">User.associate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  User.belongsTo(model.CoachUser, &#123; <span class="attr">foreignKey</span>: <span class="string">'coachid'</span> &#125;);</div><div class="line">  User.belongsTo(model.Lesson, &#123; <span class="attr">foreignKey</span>: <span class="string">'lessonid'</span> &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 查询</span></div><div class="line">User.findAll(&#123;</div><div class="line">  where: &#123; <span class="attr">userid</span>: userid &#125;,</div><div class="line">  include: [</div><div class="line">    &#123; <span class="attr">model</span>: LessonModel, <span class="attr">include</span>: [ShopModel, CoachModel] &#125;,</div><div class="line">    &#123; <span class="attr">model</span>: CoachModel &#125;</div><div class="line">  ]</div><div class="line">&#125;).then(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(users);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>关于外键的定义可以参看<a href="http://docs.sequelizejs.com/manual/tutorial/associations.html" target="_blank" rel="noopener">sequelizejs Associations</a>。</p>
<p>由于最新版本的 <code>sequelizejs</code> 中在where中比较的key已经切换到 <code>Symbol</code> 数据类型来实现了，所以使用基本的比较需要用以下方式：<br><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> Op = Sequelize.Op;</div><div class="line">Post.findAll(&#123;</div><div class="line">  where: &#123;</div><div class="line">    authorId: &#123;</div><div class="line">      [Op.or]: [<span class="number">12</span>, <span class="number">13</span>]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></div></pre></td></tr></table></figure></p>
<p>使用这种 <code>Op.or</code> 的方式来代表sql中的OR，所有的操作列表参见<a href="http://docs.sequelizejs.com/manual/tutorial/querying.html#operators" target="_blank" rel="noopener">sequelizejs Operators</a>。</p>
<h2 id="3-egg-sequelize-的使用"><a href="#3-egg-sequelize-的使用" class="headerlink" title="3. egg-sequelize 的使用"></a>3. egg-sequelize 的使用</h2><p>在 egg 中使用 Sequelize，可以直接使用<a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener">egg-sequelize</a>。</p>
<h3 id="3-1-egg-sequelize-的安装及配置"><a href="#3-1-egg-sequelize-的安装及配置" class="headerlink" title="3.1 egg-sequelize 的安装及配置"></a>3.1 egg-sequelize 的安装及配置</h3><p>安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ npm i --save egg-sequelize</div><div class="line">$ npm install --save mysql2 <span class="comment"># For both mysql and mariadb dialects</span></div><div class="line"></div><div class="line"><span class="comment"># Or use other database backend.</span></div><div class="line">$ npm install --save pg pg-hstore <span class="comment"># PostgreSQL</span></div><div class="line">$ npm install --save tedious <span class="comment"># MSSQL</span></div></pre></td></tr></table></figure>
<p>配置：</p>
<ul>
<li>config.default.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 配置数据库连接的基本参数</span></div><div class="line">exports.sequelize = &#123;</div><div class="line">  dialect: <span class="string">'mysql'</span>, <span class="comment">// support: mysql, mariadb, postgres, mssql</span></div><div class="line">  database: <span class="string">'test'</span>,</div><div class="line">  host: <span class="string">'localhost'</span>,</div><div class="line">  port: <span class="string">'3306'</span>,</div><div class="line">  username: <span class="string">'root'</span>,</div><div class="line">  password: <span class="string">''</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>config/plugin.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 在egg插件中启用egg-sequelize</span></div><div class="line">exports.sequelize = &#123;</div><div class="line">  enable: <span class="literal">true</span>,</div><div class="line">  package: <span class="string">'egg-sequelize'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>package.json</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"migrate:new"</span>: <span class="string">"egg-sequelize migration:create"</span>,</div><div class="line">    <span class="string">"migrate:up"</span>: <span class="string">"egg-sequelize db:migrate"</span>,</div><div class="line">    <span class="string">"migrate:down"</span>: <span class="string">"egg-sequelize db:migrate:undo"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-egg-sequelize-的使用事项"><a href="#3-2-egg-sequelize-的使用事项" class="headerlink" title="3.2 egg-sequelize 的使用事项"></a>3.2 egg-sequelize 的使用事项</h3><p>因为 <code>egg-sequelize</code> 只是 egg 中对 <code>sequelizejs</code> 的一层封装，所以只需要明白对应关系，其他的使用参照 sequliezejs 文档即可。</p>
<ul>
<li><p>按照上面的安装步骤在egg中安装 <code>sequelizejs</code> 后，app.model 就是一个Sequelize的实例，相当于原文档中 new 的 Sequelize 的对象。主要引入代码就下面这一个文件，所以如果有一些插件下无法修改的一些东西，完全可以自己写一个。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// egg-sequelize/lib/loader.js</span></div><div class="line">app.Sequelize = Sequelize;</div><div class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(config.database, config.username, config.password, config);</div></pre></td></tr></table></figure>
</li>
<li><p>上面提到的比较操作在最新版本中推荐使用operators来实现，在egg中可以通过 <code>this.app.Sequelize.Op.gt</code> 这种方式实现</p>
</li>
</ul>
<h2 id="4-sequelizejs常用基本用法速查表"><a href="#4-sequelizejs常用基本用法速查表" class="headerlink" title="4 sequelizejs常用基本用法速查表"></a>4 sequelizejs常用基本用法速查表</h2><table>
<thead>
<tr>
<th style="text-align:center">列表</th>
<th style="text-align:center">文档地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1、</td>
<td style="text-align:center"><a href="http://docs.sequelizejs.com/variable/index.html#static-variable-DataTypes" target="_blank" rel="noopener">定义model支持的类型</a></td>
</tr>
<tr>
<td style="text-align:center">2、</td>
<td style="text-align:center"><a href="http://docs.sequelizejs.com/manual/tutorial/querying.html#operators" target="_blank" rel="noopener">比较操作符</a></td>
</tr>
</tbody>
</table>
<h2 id="5-参考文档"><a href="#5-参考文档" class="headerlink" title="5 参考文档"></a>5 参考文档</h2><p>1.<a href="http://docs.sequelizejs.com/manual/installation/usage.html" target="_blank" rel="noopener">sequelizejs官方文档</a><br>2.<a href="http://docs.sequelizejs.com/identifiers.html" target="_blank" rel="noopener">sequelizejs官方API</a><br>3.<a href="https://itbilu.com/nodejs/npm/VkYIaRPz-.html" target="_blank" rel="noopener">Sequelize 中文API文档－1. 快速入门、Sequelize类</a><br>4.<a href="https://itbilu.com/nodejs/npm/V1PExztfb.html" target="_blank" rel="noopener">Sequelize 中文API文档－2. Model 的定义、使用与Model类的API</a><br>5.<a href="https://itbilu.com/nodejs/npm/41qaV3czb.html" target="_blank" rel="noopener">Sequelize 中文API文档－3. 模型（表）之间的关系/关联</a><br>6.<a href="https://itbilu.com/nodejs/npm/VJIR1CjMb.html" target="_blank" rel="noopener">Sequelize 中文API文档－4. 查询与原始查询</a><br>7.<a href="https://itbilu.com/nodejs/npm/N1sdaHTzb.html" target="_blank" rel="noopener">Sequelize 中文API文档－5. 实例的使用、Instance类介绍</a></p>

        <div class="guide-links">
            
            
                <span style="float:right"><a href="/blog/2018/03/13/2018-03-13-banip/">linux服务器初级防护</a> →</span>
            
        </div>
    </div>

  </div>
  
  
<script>
var topScrolled = false
window.addEventListener('scroll', function () {
  if (window.pageYOffset > 165 && !topScrolled) {
    topScrolled = true
    document.getElementById('mobile-bar').classList.remove('top')
  } else if (window.pageYOffset <= 165 && topScrolled) {
    topScrolled = false
    document.getElementById('mobile-bar').classList.add('top')
  }
})
</script>
<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/blog/js/script.js"></script>
<script src="/blog/js/common.js"></script>
<script>

    let $a = document.querySelectorAll('.blog p:not(.article-more-link)>a,.content.docs p>a,.article-inner p:not(.article-more-link)>a')
    $a.forEach(($em) => {
      $em.setAttribute('target', '_blank')
    })

</script>


  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("HmeL0Aj2Mp5kT83LC723uQtt-gzGzoHsz", "0dnLgsnCdC4dFXd4wMci4Nyn");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>




</body>
</html>

